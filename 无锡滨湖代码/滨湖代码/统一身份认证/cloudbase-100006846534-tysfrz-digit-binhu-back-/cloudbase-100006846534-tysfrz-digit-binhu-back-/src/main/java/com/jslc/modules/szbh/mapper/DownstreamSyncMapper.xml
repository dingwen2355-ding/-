<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jslc.modules.szbh.mapper.DownstreamSyncMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="downstreamSyncResultMap" type="com.jslc.modules.szbh.entity.DownstreamSync">
        <result column="id" property="id"/>
        <result column="create_user" property="createUser"/>
        <result column="create_time" property="createTime"/>
        <result column="update_user" property="updateUser"/>
        <result column="update_time" property="updateTime"/>
        <result column="is_deleted" property="isDeleted"/>
        <result column="app_id" property="appId"/>
        <result column="data_type" property="dataType"/>
        <result column="sync_dept" property="syncDept"/>
        <result column="sync_field" property="syncField"/>
    </resultMap>

    <resultMap id="downstreamSyncVOResultMap" type="com.jslc.modules.szbh.vo.DownstreamSyncVO" extends="downstreamSyncResultMap">

    </resultMap>


    <select id="selectDownstreamSyncPage" resultMap="downstreamSyncVOResultMap">
        select bds.*,bam.name as appName from bh_downstream_sync bds
		inner join bh_application_management bam on bam.id = bds.app_id and bam.is_deleted = 0
		where bds.is_deleted = 0
		<if test="key != null">
            and bam.name like concat('%',#{key},'%')
        </if>
    </select>
    <select id="getDetail" resultType="com.jslc.modules.szbh.vo.DownstreamSyncVO">
        select bds.*,bam.name as appName from bh_downstream_sync bds
		left join bh_application_management bam on bam.id = bds.app_id and bam.is_deleted = 0
		where bds.id = #{id}
    </select>
    <select id="getAppName" resultType="java.lang.String">
        select name from bh_application_management where id = #{appId}
    </select>

    <select id="getUserAccount" resultType="java.lang.String">
        select distinct bu.account from bh_user bu
        where is_deleted = 0
        <if test="deptIds != null">
            and(
            <foreach collection="deptIds" item="id" index="index" separator="or">
                (bu.major_dept = #{id} or POSITION(#{id} IN bu.other_dept))
            </foreach>
            )
        </if>
    </select>

    <select id="getDownByDeptId" resultMap="downstreamSyncResultMap">
        select distinct bds.* from bh_downstream_sync bds
        where  bds.data_type = '人员信息' and (bds.sync_dept = #{deptId} or POSITION(#{deptId} IN bds.sync_dept)) and bds.is_deleted = 0
    </select>

</mapper>
