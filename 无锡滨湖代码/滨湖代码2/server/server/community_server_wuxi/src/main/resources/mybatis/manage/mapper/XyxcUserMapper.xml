<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.znv.manage.dao.XyxcUserDao">

    <select id="queryUserInfo" resultType="map">
        SELECT
            user_id userId,
            name,
            mobile,
            positions
        FROM
            tbl_users
        where 1=1
            <if test="userId != null and userId != ''">and user_id = #{userId}</if>
    </select>

    <insert id="saveUserGps" parameterType="list">
        INSERT INTO t_data_user_gps ( user_id, clock_time, `name`, mobile, position, `status`, gpsx, gpsy, departments)
        VALUES
        <foreach collection="list" item="item" index="index" separator=",">
            (#{item.userId},#{item.clockTime},#{item.name},#{item.mobile},#{item.position},#{item.status},#{item.gpsx},#{item.gpsy},#{item.dept})
        </foreach>
        on duplicate key update
        `name` = values(`name`),
        mobile = values(mobile),
        clock_time = values(clock_time),
        position = values(position),
        `status` = values(`status`),
        gpsx = values(gpsx),
        gpsy = values(gpsy),
        departments = values(departments)
    </insert>

    <select id="queryUserDept" resultType="String">
        select ifnull(departments,'') from t_data_user_gps where user_id = #{userId} and TO_DAYS(clock_time) = TO_DAYS(NOW()) order by clock_time desc limit 1
    </select>


    <select id="queryUserGpsList" resultType="map">
        SELECT
        t.user_id userId,
        t.gpsx,
        t.gpsy,
        case when t.`status` = 1 then '在岗'else '不在岗'end as status
        FROM
        (
        SELECT
        max(clock_time) AS clock_time,
        user_id
        FROM
        t_data_user_gps
        where ifnull(gpsx,'') != ''and ifnull(gpsy,'') != ''
        <if test="userId != null and userId != ''">and user_id = #{userId}</if>
        <if test="names != null">and find_in_set(name,#{names})</if>
        <if test="dept != null and dept != ''">and departments like CONCAT('%',#{dept},'%')</if>
        GROUP BY
        user_id
        ) a
        LEFT JOIN t_data_user_gps t ON t.user_id = a.user_id
        AND t.clock_time = a.clock_time
    </select>

    <select id="queryUserGpsListByUserId" resultType="map">
        SELECT
            user_id userId,
            gpsx,
            gpsy,
            date_format(clock_time,'%Y-%m-%d %H:%i:%s') clockTime,
            case when `status` = 1 then '在岗'else '不在岗'end as status
        FROM
            t_data_user_gps
        where user_id = #{userId}
        ORDER BY clock_time
    </select>

    <select id="queryUserInfo2" resultType="map">
        SELECT
        user_id userId,
        `name`,
        mobile,
        position positions,
        departments departments,
        case when `status` = 1 then '在岗'else '不在岗'end as status
        FROM
        t_data_user_gps
        where 1=1
        <if test="userId != null and userId != ''">and user_id = #{userId}</if>
        <if test="names != null">and find_in_set(`name`,#{names})</if>
        <if test="userIds != null">and find_in_set(user_id,#{userIds})</if>
        <if test="dept != null and dept != ''">and departments like CONCAT('%',#{dept},'%')</if>
        group by user_id,`name`,mobile,positions,departments
    </select>
</mapper>